---
title: "Fb_videoDownloader.Js"
date: "2023-11-23"
categories: 
  - "useful-script-en"
---

how to add bookmarklet in chrome  
![](https://camo.githubusercontent.com/5f21e427a7d3ee887313a4f9b1ab033e6462db47ca299bf3f7e2d81a0ce854bd/68747470733a2f2f696d672e7765626e6f74732e636f6d2f323031392f30342f447261672d616e642d44726f702d4c696e6b732d696e2d4368726f6d652e706e67)`import { getCurrentTab, runScriptInCurrentTab, showLoading,  } from "./helpers/utils.js";  export default { icon: '', name: { en: "Download fb video/reel/watch from url", vi: "Download video/reel/watch fb from url", }, description: {  en: "Download facebook video/reel/watch", vi: "Download facebook video/reel/watch",  }, whiteList: ["https://www.facebook.com/*"],  onClickExtension: async function() { let tab = await getCurrentTab(); let url = prompt("Enter link video/reel/watch:", tab.url);  let videoId = shared.extractFbVideoIdFromUrl(url); if (!videoId) { alert( "Link is not formatted, video/reel/watch id not found in link." ); return; }  let { closeLoading, setLoadingText } = showLoading("Taking tokens..."); try { let dtsg = await shared.getDtsg(); setLoadingText("Getting video link...");  let link = await shared.getLinkFbVideo(videoId, dtsg); if (link) window.open(link); else throw Error("Link not found"); } catch (e) { alert("ERROR: " + e); } finally { closeLoading(); } }, };  export const shared = { extractFbVideoIdFromUrl: function (url) { return url.match(/\/(?:videos|reel|watch)(?:\/?) (?:\?v=)? (\d+)/)?. [1]; },  getDtsg: async function() { return await runScriptInCurrentTab(() => {  return require("DTSGInitialData").token; }); },  stringifyVariables: function (d, e) { let f = [], a; for (a in d) if (d.hasOwnProperty(a)) { let g = e ? e + "[" + a + "]" : a,  b = d[a];  f.push( null !== b && "object" == typeof b ? shared.stringifyVariables(b, g) : encodeURIComponent(g) + "=" + encodeURIComponent(b )  ); } return f.join("&"); },  getLinkFbVideo: async function(videoId, dtsg) {  try { return await shared.getLinkFbVideo2(videoId, dtsg); } catch (e) { return await shared.getLinkFbVideo1(videoId, dtsg);  } },  Original source code: https://gist.github.com/monokaijs/270e29620c46cabec1caca8c3746729d // POST FB: https://www.facebook.com/groups/j2team.community/posts/1880294815635963/ /  / Need to add a rule in rule.jsons so that this function can run in the extension context getLinkFbVideo1: async function(videoId, dtsg) { function fetchGraphQl(doc_id, variables) { return fetch("https://www.facebook.com/api/graphql/", { method: "POST", headers: { "content-type": "application/x-www-form-urlencoded", }, body: shared.stringifyVariables({ doc_id: doc_id, variables: JSON.stringify(variables), fb_dtsg: dtsg, server_timestamps: !0,  }),  }); }  let res = await fetchGraphQl(“5279476072161634”, { UFI2CommentsProvider_commentsKey: “CometTahoeSidePaneQuery”, caller: “CHANNEL_VIEW_FROM_PAGE_TIMELINE”, displayCommentsContextEnableComment: null, displayCommentsContextIsAdPreview: null, displayCommentsContextIsAggregatedShare: null, displayCommentsContextIsStorySet: null, displayCommentsFeedbackContext: null, feedbackSource: 41, feedLocation: “TAHOE”, focusCommentID: null, privacySelectorRenderLocation: “COMET_STREAM”, renderLocation: “video_channel”, scale: 1, streamChainingSection: !1, useDefaultActor: !1, videoChainingContext: null, videoID: videoId, }); let text = await res.text();  let a = JSON.parse(text.split(“\n”)[0]), link = a.data.video.playable_url_quality_hd || a.data.video.playable_url;  return link; },  // DYL extension: faster getLinkFbVideo2: async function (videoId, dtsg) { let res = await fetch( “https://www.facebook.com/video/video_data_async/?video_id=” + videoId, { method: “POST”, headers: { “content-type”: “application/x-www-form-urlencoded” }, body: shared.stringifyVariables({ __a: “1”, fb_dtsg: dtsg, }), } );  let text = await res.text(); console.log(text); text = text.replace(“for (;;);”, “”); let json = JSON.parse(text);  const { hd_src, hd_src_no_ratelimit, sd_src, sd_src_no_ratelimit } = json?.payload || {};  return hd_src_no_ratelimit || hd_src || sd_src_no_ratelimit || sd_src; },  // DYL extension: use access token getLinkFbVideo3: async function (videoId, access_token) { let res = await fetch( “https://graph.facebook.com/v8.0/” + videoId + “?fields=source&access_token=” + access_token ); let json = await res.json(); return json.source; }, };`
